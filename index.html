<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piegādes Maršruta Aplikācija</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s, opacity 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-danger-outline { background-color: #fef2f2; color: #ef4444; border: 1px solid #fecaca; }
        .btn-danger-outline:hover { background-color: #fee2e2; }
        .btn-skip { background-color: #3b82f6; color: white; }
        .btn-skip:hover { background-color: #2563eb; }
        .btn-refused { background-color: #f97316; color: white; }
        .btn-refused:hover { background-color: #ea580c; }

        .input-field {
            width: 100%; padding: 0.75rem; border: 1px solid #d1d5db;
            border-radius: 0.5rem; font-size: 1.25rem; text-align: center;
        }
        .modal-overlay { transition: opacity 0.3s ease; }
        .status-badge {
            display: inline-block; padding: 0.5em 0.75em; font-size: 0.875rem;
            font-weight: 600; line-height: 1; text-align: center;
            white-space: nowrap; vertical-align: baseline; border-radius: 9999px;
            color: white;
        }
        .highlight {
            font-style: italic;
            font-weight: 700;
            color: #8b5cf6;
        }
        .highlight-farm {
            font-weight: 700;
            color: #166534; /* Darker Green */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="max-w-md w-full mx-auto">
        <!-- Upload View (now hidden by default) -->
        <div id="upload-view" class="card p-8 text-center space-y-6 relative" style="display: none;">
            <svg class="mx-auto h-16 w-16 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <h1 class="text-3xl font-bold text-gray-800">Piegādes Aplikācija</h1>
            <p class="text-gray-600">Lai sāktu, ielādējiet maršruta Excel (.xlsx) vai .csv failu.</p>
            <p id="upload-error" class="text-red-500 text-sm" style="display: none;"></p>
            <button id="upload-button" class="w-full btn btn-primary">Ielādēt Maršrutu</button>
            <input type="file" id="file-input" class="hidden" accept=".csv, text/csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
            <div class="absolute bottom-4 right-4 text-xs text-gray-400">
                <button id="whats-new-button" class="underline hover:text-indigo-600">Kas jauns?</button>
                <span class="ml-2">v40</span>
            </div>
        </div>

        <!-- Current Stop View -->
        <div id="current-stop-view" class="card p-6 md:p-8 space-y-4" style="display: none;">
            <header class="text-center relative">
                <h1 class="text-2xl font-bold text-gray-800">Maršruts</h1>
                <p id="stop-counter" class="text-lg font-semibold text-indigo-600"></p>
                 <div id="route-health-indicator" class="mt-2 text-sm font-medium p-2 rounded-lg" style="display: none;"></div>
                <div id="progress-indicator" class="text-xs sm:text-sm text-gray-500 font-medium mt-1"></div>
                <div id="payment-status-badge" class="absolute top-0 right-0"></div>
            </header>

            <div id="customer-info" class="p-4 bg-gray-50 rounded-lg space-y-3">
                 <div class="flex items-center"><svg class="w-6 h-6 text-gray-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p id="customer-time" class="text-xl font-bold text-indigo-700"></p></div>
                 <div class="flex items-center justify-between">
                    <div class="flex items-center min-w-0">
                        <svg class="w-6 h-6 text-gray-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <p id="customer-address" class="text-lg font-semibold text-gray-700 truncate"></p>
                    </div>
                    <button id="navigate-button" class="btn btn-secondary !py-2 !px-3 ml-2 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                        <span class="ml-2 hidden sm:inline">Navigēt</span>
                    </button>
                </div>
                 <div class="flex items-center"><svg class="w-6 h-6 text-gray-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg><p id="customer-phone" class="text-xl font-bold text-gray-800"></p></div>
            </div>

            <div id="status-reason-display" class="p-3 text-center rounded-lg" style="display: none;"></div>

            <div class="border-t pt-4"><p id="customer-order" class="text-center text-xl font-semibold text-indigo-700 my-2"></p><p id="price-per-kg" class="text-center text-sm text-indigo-600 font-medium"></p><p id="extra-fee" class="text-center text-sm font-semibold text-red-500"></p><div id="weight-inputs-container" class="mt-2 space-y-3"></div></div>
            <div id="subi-section" class="border-t pt-4" style="display: none;"><p id="customer-order-2" class="text-center text-xl font-semibold text-indigo-700 my-2"></p><p id="price-per-item" class="text-center text-sm text-indigo-600 font-medium"></p><input type="number" id="subi-input" class="input-field mt-2" placeholder="SUBI svars (kg)" step="0.01"></div>
            <div id="total-price-container" class="text-center p-4 bg-indigo-50 rounded-lg transition-colors duration-300"><p class="text-md font-medium text-gray-600">Kopējā summa apmaksai:</p><p id="total-price" class="text-4xl font-bold text-indigo-700">€0.00</p></div>
            <div id="status-button-container" class="grid grid-cols-1 sm:grid-cols-3 gap-2"></div>
            
            <div class="grid grid-cols-3 gap-2 mt-4">
                 <button id="prev-button" class="btn btn-secondary">Atpakaļ</button>
                 <button id="add-fuel-button-main" class="btn btn-secondary">Degviela</button>
                 <button id="next-button" class="btn btn-primary">Tālāk</button>
            </div>
            <button id="toggle-route-list" class="w-full text-center text-sm text-gray-500 hover:text-gray-700 mt-2">Rādīt/Slēpt maršruta sarakstu</button>
        </div>

        <div id="summary-view" class="card p-8 text-center space-y-6 hidden"></div>
        <div id="route-list-view" class="card mt-4 p-6 hidden"></div>
    </div>
    <div id="modal-container" class="fixed inset-0 z-50" style="display: none;"></div>

<script>
    // --- TEMPLATES ---
    const summaryTemplate = (kgBreakdown, finances, routeInfo) => `<h1 class="text-3xl font-bold text-gray-800">Dienas Atskaite</h1>
        <div class="text-left text-gray-600 border-b pb-4 mb-4">
             <p><strong>Šoferis:</strong> ${routeInfo.driver || 'Nav norādīts'}</p>
             <p><strong>Datums:</strong> ${routeInfo.date || 'Nav norādīts'}, ${routeInfo.weekday || ''}</p>
        </div>
        <div class="space-y-6 text-left"><div><h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-2">Pārdotie Produkti</h2><div class="flex justify-between"><span class="text-gray-600">Cūkgaļa:</span><span class="font-bold">${kgBreakdown.pork.toFixed(2)} kg</span></div><div class="flex justify-between"><span class="text-gray-600">Subprodukti (SUBI):</span><span class="font-bold">${kgBreakdown.subi.toFixed(2)} kg</span></div><div class="flex justify-between font-bold text-lg border-t mt-2 pt-2"><span class="text-gray-800">Kopā pārdots:</span><span>${kgBreakdown.total.toFixed(2)} kg</span></div></div><div><h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-2">Finanšu Pārskats</h2><div class="flex justify-between"><span class="text-gray-600">Iekasēts no klientiem:</span><span class="font-bold text-green-600">+ €${finances.collected.toFixed(2)}</span></div><div class="flex justify-between"><span class="text-gray-600">Izdots degvielai:</span><span class="font-bold text-red-600">- €${finances.fuel.toFixed(2)}</span></div><div class="flex justify-between font-bold text-lg border-t mt-2 pt-2"><span class="text-gray-800">Naudas atlikums:</span><span>€${finances.balance.toFixed(2)}</span></div></div></div><button id="restart-button" class="w-full btn btn-primary mt-6">Sākt jaunu maršrutu</button>`;
    const routeListTemplate = (customers, customerData) => {
        const statusMap = {
            serviced: { liBg: 'bg-green-50', circleBg: 'bg-green-500', circleText: 'text-white' },
            skipped: { liBg: 'bg-blue-50', circleBg: 'bg-blue-500', circleText: 'text-white' },
            refused: { liBg: 'bg-orange-50', circleBg: 'bg-orange-500', circleText: 'text-white' },
            pending: { liBg: '', circleBg: 'bg-gray-200', circleText: 'text-gray-600' }
        };
        return `<h2 class="text-xl font-bold text-gray-800 text-center mb-4">Maršruta Saraksts</h2>
        <ul id="route-list-ul" class="divide-y divide-gray-200">${customers.map((customer, index) => {
            const status = customerData[index]?.status || 'pending'; const reason = customerData[index]?.reason || ''; const config = statusMap[status];
            return `<li class="p-3 flex items-center justify-between ${config.liBg} rounded-md">
                <div class="flex items-center min-w-0">
                    <div class="w-8 h-8 rounded-full ${config.circleBg} ${config.circleText} flex items-center justify-center text-sm font-bold mr-4 flex-shrink-0">${index + 1}</div>
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between items-baseline"><p class="text-md font-medium text-gray-900 truncate">${customer.address}</p><p class="text-sm font-bold text-indigo-600 ml-2 flex-shrink-0">${customer.time || ''}</p></div>
                        <p class="text-sm font-semibold text-gray-700">${customer.phone || 'Nav norādīts'}</p>
                        <p class="text-sm text-gray-500 mt-1">${highlightSpecialOrders(customer.order)}</p>
                        ${customer.order2 ? `<p class="text-sm text-gray-500">${highlightSpecialOrders(customer.order2)}</p>` : ''}
                        ${reason ? `<p class="text-sm text-gray-500 mt-1"><em>Iemesls: ${reason}</em></p>` : ''}
                    </div>
                </div>
                <button data-index="${index}" class="edit-customer-btn btn btn-secondary !p-2 ml-2 flex-shrink-0"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
            </li>`;
        }).join('')}</ul>
        <button id="add-customer-button" class="w-full btn btn-secondary mt-2">Pievienot jaunu klientu</button>`;
    };
    const confirmationModalTemplate = (title, text, confirmText, confirmClass, onConfirm) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center p-4';
        modal.innerHTML = `<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">${title}</h3><p class="mt-2 text-sm text-gray-600">${text}</p><div class="items-center mt-4 px-4 py-3 space-y-2 sm:space-y-0 sm:flex sm:flex-row-reverse"><button id="modal-confirm" class="w-full sm:w-auto btn ${confirmClass} sm:ml-3">${confirmText}</button><button id="modal-cancel" class="w-full sm:w-auto mt-2 sm:mt-0 btn btn-secondary">Atcelt</button></div></div></div>`;
        allElements.modalContainer.innerHTML = ''; allElements.modalContainer.appendChild(modal); allElements.modalContainer.style.display = 'flex';
        modal.querySelector('#modal-confirm').onclick = onConfirm; 
        modal.querySelector('#modal-cancel').onclick = hideModals;
    };
    const reasonModalTemplate = (title, quickReasons, onConfirm) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center p-4';
        modal.innerHTML = `<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">${title}</h3><div class="mt-4 space-y-2"><div class="flex flex-wrap gap-2 justify-center">${quickReasons.map(r => `<button class="btn btn-secondary quick-reason-btn">${r}</button>`).join('')}</div><input type="text" id="custom-reason-input" class="input-field !text-base" placeholder="Vai ievadi citu iemeslu..."></div><div class="items-center mt-4 px-4 py-3 sm:flex sm:flex-row-reverse"><button id="modal-confirm-reason" class="w-full sm:w-auto btn btn-primary sm:ml-3">Apstiprināt</button><button id="modal-cancel" class="w-full sm:w-auto mt-2 sm:mt-0 btn btn-secondary">Atcelt</button></div></div></div>`;
        allElements.modalContainer.innerHTML = ''; allElements.modalContainer.appendChild(modal); allElements.modalContainer.style.display = 'flex';
        modal.querySelectorAll('.quick-reason-btn').forEach(btn => btn.onclick = () => { document.getElementById('custom-reason-input').value = btn.textContent; });
        modal.querySelector('#modal-confirm-reason').onclick = () => { const reason = document.getElementById('custom-reason-input').value; onConfirm(reason); };
        modal.querySelector('#modal-cancel').onclick = hideModals;
    };
    const fuelModalTemplate = (onConfirm) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center p-4';
        modal.innerHTML = `<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Degvielas izdevumi</h3><p class="mt-2 text-sm text-gray-600">Ievadiet summu, kas iztērēta degvielai.</p><div class="mt-4"><input type="number" id="fuel-amount-input" class="input-field" placeholder="Summa (€)" step="0.01"></div><div class="items-center mt-4 px-4 py-3 sm:flex sm:flex-row-reverse"><button id="modal-confirm-fuel" class="w-full sm:w-auto btn btn-primary sm:ml-3">Saglabāt</button><button id="modal-cancel" class="w-full sm:w-auto mt-2 sm:mt-0 btn btn-secondary">Atcelt</button></div></div></div>`;
        allElements.modalContainer.innerHTML = ''; allElements.modalContainer.appendChild(modal); allElements.modalContainer.style.display = 'flex';
        modal.querySelector('#modal-confirm-fuel').onclick = () => { const amount = parseFloat(document.getElementById('fuel-amount-input').value) || 0; if (amount > 0) onConfirm(amount); hideModals(); };
        modal.querySelector('#modal-cancel').onclick = hideModals;
    };
    const editCustomerModalTemplate = (customer, index) => `<div class="modal-overlay bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center p-4"><div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white"><h3 class="text-xl leading-6 font-medium text-gray-900 text-center">${index === null ? 'Pievienot jaunu klientu' : `Labot klientu #${index + 1}`}</h3><div class="mt-4 space-y-4"><div><label class="block text-sm font-medium text-gray-700">Plānotais laiks</label><input type="text" id="edit-time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer.time || ''}"></div><div><label class="block text-sm font-medium text-gray-700">Adrese</label><input type="text" id="edit-address" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer.address || ''}"></div><div><label class="block text-sm font-medium text-gray-700">Telefons</label><input type="text" id="edit-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer.phone || ''}"></div><div><label class="block text-sm font-medium text-gray-700">Pamatprodukts</label><input type="text" id="edit-order1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer.order || ''}"></div><div><label class="block text-sm font-medium text-gray-700">Otrs pasūtījums (SUBI)</label><input type="text" id="edit-order2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer.order2 || ''}"></div></div><div class="items-center mt-6 px-4 py-3 sm:flex sm:flex-row-reverse"><button id="edit-save-btn" data-index="${index}" class="w-full sm:w-auto btn btn-primary sm:ml-3">Saglabāt</button><button id="edit-cancel-btn" class="w-full sm:w-auto mt-2 sm:mt-0 btn btn-secondary">Atcelt</button></div></div></div>`;
    const whatsNewModalTemplate = () => `<div class="modal-overlay bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center p-4">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <h3 class="text-xl leading-6 font-medium text-gray-900 text-center">Kas jauns versijā v40?</h3>
            <ul class="mt-4 space-y-3 text-sm text-gray-600 list-disc list-inside">
                <li><b>Iebūvēts Maršruts:</b> Aplikācija tagad automātiski ielādē šodienas maršrutu. Faila augšupielāde vairs nav nepieciešama.</li>
                <li><b>Datu saglabāšana:</b> Aplikācija joprojām automātiski saglabā jūsu progresu. Ja nejauši aizverat pārlūku, varēsiet turpināt darbu no pēdējās saglabātās vietas.</li>
                <li><b>Navigācijas poga:</b> Katram klientam ir pievienota "Navigēt" poga, kas atver adresi Google Maps.</li>
            </ul>
            <div class="mt-6 text-center">
                <button id="close-whats-new" class="btn btn-primary">Aizvērt</button>
            </div>
        </div>
    </div>`;
    
    const allElements = { uploadView: document.getElementById('upload-view'), uploadButton: document.getElementById('upload-button'), fileInput: document.getElementById('file-input'), uploadError: document.getElementById('upload-error'), currentStopView: document.getElementById('current-stop-view'), summaryView: document.getElementById('summary-view'), progressIndicator: document.getElementById('progress-indicator'),stopCounter: document.getElementById('stop-counter'), customerAddress: document.getElementById('customer-address'), customerPhone: document.getElementById('customer-phone'), customerOrder: document.getElementById('customer-order'), customerTime: document.getElementById('customer-time'), pricePerKgEl: document.getElementById('price-per-kg'), extraFee: document.getElementById('extra-fee'), totalPriceEl: document.getElementById('total-price'), totalPriceContainer: document.getElementById('total-price-container'), nextButton: document.getElementById('next-button'), prevButton: document.getElementById('prev-button'), toggleRouteListBtn: document.getElementById('toggle-route-list'), routeListView: document.getElementById('route-list-view'), subiSection: document.getElementById('subi-section'), customerOrder2: document.getElementById('customer-order-2'), pricePerItem: document.getElementById('price-per-item'), subiInput: document.getElementById('subi-input'), weightInputsContainer: document.getElementById('weight-inputs-container'), modalContainer: document.getElementById('modal-container'), statusButtonContainer: document.getElementById('status-button-container'), paymentStatusBadge: document.getElementById('payment-status-badge'), statusReasonDisplay: document.getElementById('status-reason-display'), routeHealthIndicator: document.getElementById('route-health-indicator'), addFuelButtonMain: document.getElementById('add-fuel-button-main'), whatsNewButton: document.getElementById('whats-new-button'), };
    const STORAGE_KEY = 'deliveryRouteData_v1';
    // Default route data is now embedded in the code
    const defaultRouteData = `,,SVETDIENA DAINIS 2025.09.14,,Izveides laiks,,,,,
nr,Laiks,ADRESE,dziv,Telefons,Pasut_1,,CENU kategorija,Pasut_2,PIEZIMES,summa
1,2:30,"Valles, Rumbas pag.",,,2:00 jābūt bāzē.                2:30 jābūt uzkrautam VIENMER NODOT NAUDU BĀZĒ,,,,,
2,5:25,"Birzes iela 33, Skrīveri",,26199929,"puscuka SADALITA MAZAKO              3,65 plus 10  MARSILI",40,marsili sivv,.....,
3,6:38,"Kalna iela 10, Jēkabpils",,26123712,"aizmugure MAZAKO 5,65 MM",20,vip dargais mm,,,
4,7:04,"Celtnieku iela 19, Jēkabpils                 4. un 5. točka jau kopā samaksāja 165 eur konta izdot atlikumu",40,29511149,"prieksa 3,95 MM",20,akcija arpuskartas,.....,
5,7:30,"Bebru iela 7, Jēkabpils                4. un 5. točka jau kopā samaksāja 165 eur konta izdot atlikumu",18,2013...`;

    let customers = []; let customerData = []; let currentStopIndex = 0; let fuelExpenses = []; let routeInfo = {};
    const standardKeywords = ['puscuka', 'plus', 'prieksa', 'aizmugure', 'sadalita', 'subi', 'bez', 'plausam'];
    const farmKeywords = ['mm', 'ozolu', 'mars', 'marsili'];

    function saveState() { try { const state = { customers, customerData, currentStopIndex, fuelExpenses, routeInfo }; localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { console.error("Failed to save state:", e); } }
    function loadState() { try { const savedState = localStorage.getItem(STORAGE_KEY); if (savedState) return JSON.parse(savedState); } catch (e) { console.error("Failed to load state:", e); localStorage.removeItem(STORAGE_KEY); } return null; }
    function clearState() { localStorage.removeItem(STORAGE_KEY); }
    function parseCsvRow(row) { const result = []; let currentField = ''; let inQuotes = false; for (let i = 0; i < row.length; i++) { const char = row[i]; if (char === '"' && (i === 0 || row[i-1] !== '\\')) { inQuotes = !inQuotes; } else if (char === ',' && !inQuotes) { result.push(currentField); currentField = ''; } else { currentField += char; } } result.push(currentField); return result.map(field => field.trim().replace(/^"|"$/g, '').trim()); }
    function parseHeaderInfo(headerRowText) { if (!headerRowText) return {}; const columns = parseCsvRow(headerRowText); const infoString = columns[2] || ''; const parts = infoString.split(' ').filter(p => p.length > 0); if (parts.length >= 3) { return { weekday: parts[0], driver: parts[1], date: parts[2] }; } return { driver: infoString }; }
    function parseCSV(data) { const rows = data.trim().split('\n'); routeInfo = parseHeaderInfo(rows[0]); let headerIndex = rows.findIndex(row => row.toLowerCase().includes('adrese') && row.toLowerCase().includes('pasut_1')); if (headerIndex === -1) headerIndex = 0; const dataRows = rows.slice(headerIndex + 1); return dataRows.map(row => { const columns = parseCsvRow(row); if (columns.length < 9) return null; return { time: columns[1], address: columns[2], phone: columns[4], order: columns[5], order2: columns[8] }; }).filter(c => c && c.address && c.address.length > 3 && extractPrice(c.order) !== null); }
    function extractPrice(orderText) { if (!orderText) return null; const match = orderText.match(/(\d+[\.,]\d+)/); return match ? parseFloat(match[1].replace(',', '.')) : null; }
    function extractExtraFee(orderText) { if (!orderText) return 0; const match = orderText.match(/plus\s+(\d+)/i); return match && match[1] ? parseFloat(match[1]) : 0; }
    function highlightSpecialOrders(orderText) { if (!orderText) return ''; return orderText.split(' ').map(word => { const cleanWord = word.toLowerCase().replace(/[\.,]/g, ''); if (farmKeywords.includes(cleanWord)) { return `<span class="highlight-farm">${word}</span>`; } if (isNaN(cleanWord) && !standardKeywords.includes(cleanWord) && cleanWord.length > 0) { return `<span class="highlight">${word}</span>`; } return word; }).join(' '); }
    
    function calculateCollectedMoney() { let totalMoney = 0; customers.forEach((customer, index) => { if (customerData[index]?.status === 'serviced') { totalMoney += calculateCustomerTotal(index); } }); return totalMoney; }
    function calculateFuelTotal() { return fuelExpenses.reduce((a, b) => a + b, 0); }
    function calculateKgBreakdown() { let porkKg = 0; let subiKg = 0; customerData.forEach(data => { if (data.status !== 'serviced') return; const weights = data.weights || {}; let mainKg = (weights.kg || 0) + (weights.prieksa1 || 0) + (weights.aizmugure1 || 0) + (weights.dpPrieksa1 || 0) + (weights.dpAizmugure1 || 0) + (weights.dpPrieksa2 || 0) + (weights.dpAizmugure2 || 0); porkKg += mainKg; subiKg += weights.subi || 0; }); return { pork: porkKg, subi: subiKg, total: porkKg + subiKg }; }
    function autoSaveCurrentData() { const currentData = customerData[currentStopIndex]; if (!currentData) return; currentData.weights = currentData.weights || {}; document.querySelectorAll('#weight-inputs-container input, #subi-input').forEach(input => { if (input.offsetParent !== null) { currentData.weights[input.id.replace('-input', '')] = parseFloat(input.value) || 0; } }); updateDisplayOnSave(); saveState(); }
    function calculateCustomerTotal(index) { if (index >= customers.length) return 0; const customer = customers[index]; const data = customerData[index] || {}; const weights = data.weights || {}; let currentTotal = 0; let mainKg = (weights.kg || 0) + (weights.prieksa1 || 0) + (weights.aizmugure1 || 0) + (weights.dpPrieksa1 || 0) + (weights.dpAizmugure1 || 0) + (weights.dpPrieksa2 || 0) + (weights.dpAizmugure2 || 0); let subiKg = weights.subi || 0; const pricePerKg = extractPrice(customer.order); const extraFee = extractExtraFee(customer.order); if (pricePerKg) currentTotal += (mainKg * pricePerKg) + extraFee; const subiPrice = extractPrice(customer.order2); if (subiPrice) currentTotal += subiKg * subiPrice; return currentTotal; }
    function updateDisplayOnSave() { const collected = calculateCollectedMoney(); const fuel = calculateFuelTotal(); const balance = collected - fuel; allElements.progressIndicator.innerHTML = `<span>Iekasēts: <strong class="text-green-600">€${collected.toFixed(2)}</strong></span> | <span>Degviela: <strong class="text-red-600">€${fuel.toFixed(2)}</strong></span> | <span>Atlikums: <strong class="text-blue-600">€${balance.toFixed(2)}</strong></span>`; allElements.totalPriceEl.textContent = `€${calculateCustomerTotal(currentStopIndex).toFixed(2)}`; allElements.totalPriceContainer.classList.add('bg-green-100'); setTimeout(() => { allElements.totalPriceContainer.classList.remove('bg-green-100'); }, 800); renderStatusControls(); }
    
    function validateWeights() {
        const warnings = []; const ceturtdaļaLower = 18; const ceturtdaļaUpper = 22; const subiLower = 9; const subiUpper = 11;
        const checkWeight = (inputId, partName, lower, upper) => {
            const input = document.getElementById(inputId); if (!input || input.offsetParent === null) return; const value = parseFloat(input.value); if (!value || value <= 0) return;
            if (value < lower || value > upper) { warnings.push(`<strong>${partName}:</strong> svars (<strong>${value} kg</strong>) ir ārpus normas (${lower}-${upper} kg).`); }
        };
        const currentWeights = customerData[currentStopIndex]?.weights || {};
        for(const key in currentWeights) {
            const inputId = `${key}-input`;
            if (key.includes('prieksa') || key.includes('aizmugure') || key === 'kg') {
                checkWeight(inputId, document.querySelector(`label[for='${inputId}']`)?.textContent || 'Svars', ceturtdaļaLower, ceturtdaļaUpper);
            } else if (key === 'subi') {
                 checkWeight(inputId, 'SUBI Svars', subiLower, subiUpper);
            }
        }
        return warnings;
    }

    function renderCurrentStop() {
        if (currentStopIndex >= customers.length) {
            const kgBreakdown = calculateKgBreakdown(); const collected = calculateCollectedMoney(); const fuel = calculateFuelTotal();
            const finances = { collected, fuel, balance: collected - fuel };
            allElements.summaryView.innerHTML = summaryTemplate(kgBreakdown, finances, routeInfo); allElements.summaryView.querySelector('#restart-button').addEventListener('click', init);
            allElements.currentStopView.style.display = 'none'; allElements.routeListView.style.display = 'none'; allElements.summaryView.style.display = 'block'; return;
        }
        const customer = customers[currentStopIndex]; const data = customerData[currentStopIndex] || {}; const weights = data.weights || {};
        allElements.stopCounter.textContent = `Piegāde ${currentStopIndex + 1} no ${customers.length}`;
        allElements.customerTime.textContent = customer.time || 'Nav norādīts'; allElements.customerAddress.textContent = customer.address; allElements.customerPhone.textContent = customer.phone || 'Nav norādīts';
        document.getElementById('navigate-button').onclick = () => { const address = customers[currentStopIndex].address; const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`; window.open(url, '_blank'); };
        allElements.customerOrder.innerHTML = highlightSpecialOrders(customer.order);
        const price = extractPrice(customer.order);
        allElements.pricePerKgEl.textContent = price ? `Cena: €${price.toFixed(2)}/kg` : 'Cena nav norādīta';
        const extraFee = extractExtraFee(customer.order);
        if (extraFee > 0) { allElements.extraFee.textContent = `+ Sadalīšanas maksa: €${extraFee.toFixed(2)}`; allElements.extraFee.style.display = 'block'; } else { allElements.extraFee.style.display = 'none'; }
        allElements.weightInputsContainer.innerHTML = ''; const orderText = (customer.order || '').toLowerCase();
        if (orderText.includes('puscuka plus puscuka')) { allElements.weightInputsContainer.innerHTML = `<p class="text-md text-center font-semibold text-gray-600 border-b pb-2">Pirmā puscūka</p><div><label for="dpPrieksa1-input" class="block text-sm font-medium text-gray-700 text-left mb-1">Priekša 1 svars (kg)</label><input type="number" id="dpPrieksa1-input" class="input-field" step="0.01" value="${weights.dpPrieksa1 || '20.00'}"></div><div><label for="dpAizmugure1-input" class="block text-sm font-medium text-gray-700 text-left mb-1">Aizmugure 1 svars (kg)</label><input type="number" id="dpAizmugure1-input" class="input-field" step="0.01" value="${weights.dpAizmugure1 || '20.00'}"></div><p class="text-md text-center font-semibold text-gray-600 border-b pb-2 pt-2">Otrā puscūka</p><div><label for="dpPrieksa2-input" class="block text-sm font-medium text-gray-700 text-left mb-1">Priekša 2 svars (kg)</label><input type="number" id="dpPrieksa2-input" class="input-field" step="0.01" value="${weights.dpPrieksa2 || '20.00'}"></div><div><label for="dpAizmugure2-input" class="block text-sm font-medium text-gray-700 text-left mb-1">Aizmugure 2 svars (kg)</label><input type="number" id="dpAizmugure2-input" class="input-field" step="0.01" value="${weights.dpAizmugure2 || '20.00'}"></div>`; } 
        else if (orderText.includes('puscuka')) { allElements.weightInputsContainer.innerHTML = `<div><label for="prieksa1-input" class="block text-sm font-medium text-gray-700 text-left mb-1">Priekša svars (kg)</label><input type="number" id="prieksa1-input" class="input-field" step="0.01" value="${weights.prieksa1 || '20.00'}"></div><div><label for="aizmugure1-input" class="block text-sm font-medium text-gray-700 text-left mb-1">Aizmugure svars (kg)</label><input type="number" id="aizmugure1-input" class="input-field" step="0.01" value="${weights.aizmugure1 || '20.00'}"></div>`; } 
        else { allElements.weightInputsContainer.innerHTML = `<div><input type="number" id="kg-input" class="input-field" placeholder="Svars (kg)" step="0.01" value="${weights.kg || '20.00'}"></div>`; }
        const subiPrice = extractPrice(customer.order2); allElements.subiSection.style.display = subiPrice !== null ? 'block' : 'none';
        if (subiPrice !== null) { allElements.customerOrder2.innerHTML = highlightSpecialOrders(customer.order2); allElements.pricePerItem.textContent = `Cena: €${subiPrice.toFixed(2)}/kg`; allElements.subiInput.value = weights.subi || '10.00'; }
        updateDisplayOnSave(); autoSaveCurrentData(); document.querySelectorAll('#weight-inputs-container input, #subi-input').forEach(i => i.addEventListener('input', autoSaveCurrentData));
        renderRouteHealthIndicator();
    }
    
    function setCustomerStatus(index, status, reason = '') { customerData[index].status = status; customerData[index].reason = reason; if (status !== 'serviced') { customerData[index].paid = false; } else { customerData[index].paid = true; } renderStatusControls(); updateDisplayOnSave(); saveState(); }
    
    function renderStatusControls() {
        const { status, reason } = customerData[currentStopIndex] || { status: 'pending', reason: '' };
        const currentAmount = calculateCustomerTotal(currentStopIndex);
        const statusMap = {
            serviced: { badge: `<span class="status-badge bg-green-500">Apkalpots</span>`, buttons: `<button id="reset-status-btn" class="w-full btn btn-danger-outline">Atcelt Apmaksu</button>` },
            skipped: { badge: `<span class="status-badge bg-blue-500">Izlaists</span>`, buttons: `<button id="reset-status-btn" class="w-full btn btn-secondary">Atcelt statusu</button>` },
            refused: { badge: `<span class="status-badge bg-orange-500">Atteicās</span>`, buttons: `<button id="reset-status-btn" class="w-full btn btn-secondary">Atcelt statusu</button>` },
            pending: { badge: `<span class="status-badge bg-red-500">Gaida</span>`, buttons: `<button id="pay-btn" class="btn btn-success">Iekasēt €${currentAmount.toFixed(2)}</button><button id="skip-btn" class="btn btn-skip">Izlaist</button><button id="refuse-btn" class="btn btn-refused">Atteicās</button>` }
        };
        allElements.statusButtonContainer.innerHTML = statusMap[status].buttons;
        allElements.paymentStatusBadge.innerHTML = statusMap[status].badge;
        if(reason && status !== 'pending' && status !== 'serviced') { allElements.statusReasonDisplay.innerHTML = `<strong>Iemesls:</strong> ${reason}`; allElements.statusReasonDisplay.className = `p-3 text-center rounded-lg ${status === 'skipped' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}`; allElements.statusReasonDisplay.style.display = 'block'; } 
        else { allElements.statusReasonDisplay.style.display = 'none'; }

        const proceedToPayment = () => confirmationModalTemplate('Apmaksas apstiprinājums', `Vai tiešām iekasējāt <strong>€${currentAmount.toFixed(2)}</strong>?`, 'Jā, iekasēju', 'btn-success', () => { setCustomerStatus(currentStopIndex, 'serviced'); hideModals(); });
        
        if (document.getElementById('pay-btn')) document.getElementById('pay-btn').onclick = () => {
            const warnings = validateWeights();
            if (warnings.length > 0) {
                 confirmationModalTemplate('Nestandarta svars', `${warnings.join('<br>')}<br><br>Vai turpināt vienalga?`, 'Turpināt', 'btn-success', () => { hideModals(); proceedToPayment(); });
            } else {
                 proceedToPayment();
            }
        };
        if (document.getElementById('skip-btn')) document.getElementById('skip-btn').onclick = () => confirmationModalTemplate('Apstiprināt izlaišanu', 'Vai tiešām izlaist šo klientu?', 'Jā, izlaist', 'btn-skip', () => { hideModals(); reasonModalTemplate('Kāpēc izlaist?', ['Nav mājās', 'Sarunāts vēlāk', 'Neceļ telefonu'], (reason) => {
            setCustomerStatus(currentStopIndex, 'skipped', reason);
            setTimeout(() => handleNavigation(1), 300);
        });});
        if (document.getElementById('refuse-btn')) document.getElementById('refuse-btn').onclick = () => confirmationModalTemplate('Apstiprināt atteikumu', 'Vai tiešām atzīmēt, ka klients atteicās?', 'Jā, atteicās', 'btn-refused', () => { hideModals(); reasonModalTemplate('Kāpēc atteicās?', ['Nav naudas', 'Pārdomāja', 'Slikta kvalitāte'], (reason) => {
             setCustomerStatus(currentStopIndex, 'refused', reason);
             setTimeout(() => handleNavigation(1), 300);
        });});
        if (document.getElementById('reset-status-btn')) document.getElementById('reset-status-btn').onclick = () => setCustomerStatus(currentStopIndex, 'pending');
        allElements.nextButton.disabled = (status === 'pending');
    }

    function renderRouteHealthIndicator() {
        const indicator = allElements.routeHealthIndicator; if (currentStopIndex === 0) { indicator.style.display = 'none'; return; }
        let skippedCount = 0; let refusedCount = 0;
        for (let i = 0; i < currentStopIndex; i++) {
            const status = customerData[i]?.status;
            if (status === 'skipped') skippedCount++;
            else if (status === 'refused') refusedCount++;
        }
        if (skippedCount > 0 || refusedCount > 0) {
            let parts = [];
            if (skippedCount > 0) parts.push(`${skippedCount} ${skippedCount === 1 ? 'klients' : 'klienti'} izlaist${skippedCount === 1 ? 's' : 'i'}`);
            if (refusedCount > 0) parts.push(`${refusedCount} atteic${refusedCount === 1 ? 'ies' : 'ušies'}`);
            const message = "Uzmanību! " + parts.join(', ') + ".";
            indicator.innerHTML = `<div class="flex items-center justify-center"><svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span>${message}</span></div>`; 
            indicator.className = 'mt-2 text-sm font-medium p-2 rounded-lg bg-orange-100 text-orange-800'; 
            indicator.style.display = 'block';
        } else { 
            indicator.innerHTML = `<div class="flex items-center justify-center"><svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Viss pēc plāna! Iepriekšējie klienti apkalpoti.</span></div>`; 
            indicator.className = 'mt-2 text-sm font-medium p-2 rounded-lg bg-green-100 text-green-800'; 
            indicator.style.display = 'block';
        }
    }
    
    function handleNavigation(direction) { currentStopIndex += direction; if (currentStopIndex < 0) currentStopIndex = 0; if (currentStopIndex > customers.length) currentStopIndex = customers.length; renderCurrentStop(); saveState(); }
    function hideModals() { allElements.modalContainer.style.display = 'none'; }
    function openEditModal(customer, index) { allElements.modalContainer.innerHTML = editCustomerModalTemplate(customer, index); allElements.modalContainer.style.display = 'flex'; document.getElementById('edit-save-btn').onclick = saveCustomerFromModal; document.getElementById('edit-cancel-btn').onclick = hideModals; }
    function saveCustomerFromModal(event) { const index = parseInt(event.currentTarget.dataset.index); const updatedCustomer = { time: document.getElementById('edit-time').value, address: document.getElementById('edit-address').value, phone: document.getElementById('edit-phone').value, order: document.getElementById('edit-order1').value, order2: document.getElementById('edit-order2').value }; if (isNaN(index)) { customers.push(updatedCustomer); customerData.push({ weights: {}, status: 'pending' }); } else { customers[index] = updatedCustomer; } hideModals(); renderCurrentStop(); saveState(); }
    function loadNewRoute(csvText) {
        customers = parseCSV(csvText); if (customers.length === 0) { alert('Neizdevās nolasīt datus no iebūvētā maršruta.'); return; }
        customerData = Array(customers.length).fill(null).map(() => ({ weights: {}, status: 'pending' })); fuelExpenses = []; currentStopIndex = 0; allElements.uploadView.style.display = 'none'; allElements.summaryView.style.display = 'none'; allElements.currentStopView.style.display = 'block'; allElements.routeListView.style.display = 'none';
        hideModals(); renderCurrentStop(); saveState();
    }
    function init() { 
        clearState(); 
        loadNewRoute(defaultRouteData);
    }

    allElements.nextButton.addEventListener('click', () => handleNavigation(1));
    allElements.prevButton.addEventListener('click', () => handleNavigation(-1));
    allElements.addFuelButtonMain.addEventListener('click', () => fuelModalTemplate((amount) => { fuelExpenses.push(amount); updateDisplayOnSave(); saveState(); }));
    allElements.toggleRouteListBtn.addEventListener('click', () => {
        const isHidden = allElements.routeListView.style.display === 'none';
        if (isHidden) {
            allElements.routeListView.innerHTML = routeListTemplate(customers, customerData);
            allElements.routeListView.querySelector('#add-customer-button').addEventListener('click', () => openEditModal({}, null));
            document.querySelectorAll('.edit-customer-btn').forEach(btn => btn.addEventListener('click', (e) => {
                 const index = parseInt(e.currentTarget.dataset.index); openEditModal(customers[index], index);
            }));
        }
        allElements.routeListView.style.display = isHidden ? 'block' : 'none';
    });
    // These listeners are kept in case you want to re-enable file uploads later
    allElements.uploadButton.addEventListener('click', () => allElements.fileInput.click());
    allElements.fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
        reader.onload = (e) => { try { const csvText = file.name.endsWith('.csv') ? e.target.result : (() => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; return XLSX.utils.sheet_to_csv(worksheet); })(); clearState(); loadNewRoute(csvText); } catch (error) { console.error("File parsing error:", error); alert('Kļūda, apstrādājot failu.'); }};
        reader.onerror = () => { alert('Kļūda, nolasot failu.'); };
        if (file.name.endsWith('.csv')) { reader.readAsText(file); } else { reader.readAsArrayBuffer(file); }
    });
    allElements.whatsNewButton.addEventListener('click', () => {
        allElements.modalContainer.innerHTML = whatsNewModalTemplate();
        allElements.modalContainer.style.display = 'flex';
        allElements.modalContainer.querySelector('#close-whats-new').onclick = hideModals;
    });
    
    window.onload = () => {
        const savedState = loadState();
        if (savedState && savedState.customers?.length > 0) {
            customers = savedState.customers;
            customerData = savedState.customerData;
            currentStopIndex = savedState.currentStopIndex;
            fuelExpenses = savedState.fuelExpenses;
            routeInfo = savedState.routeInfo;
            allElements.uploadView.style.display = 'none';
            allElements.currentStopView.style.display = 'block';
            renderCurrentStop();
        } else {
            // Load the default route instead of showing the upload screen
            loadNewRoute(defaultRouteData);
        }
    };
</script>
</body>
</html>

